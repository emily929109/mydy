<script setup>
import { ref, onMounted } from "vue";
import gsap from "gsap";
import parseAPNG from "apng-js";

const img1Src = "./images/apng_v2.png";

window.onload = function () {
  const playerMap = new Map();
  const canvas = document.querySelector("#canvas");
  const ctx = canvas.getContext("2d");

  //下載圖片並轉換為純二進位數據
  async function getImgBuffer(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer(); //(純二進位數據)

    return buffer;
  }

  //apng解析
  async function initApng(url, ctx) {
    const imgBuffer = await getImgBuffer(url);
    const apng = parseAPNG(imgBuffer); //物件 裡面含getPlayer方法、寬高

    const player = await apng.getPlayer(ctx, false); //取得player

    canvas.width = apng.width;
    canvas.height = apng.height;
    playerMap.set(canvas, player);

    // Object.keys(options).forEach((key) => {
    //   apng[key] = options[key];
    // });
    // observer.observe(canvas);
    return player;
  }

  //IIFE (立即呼叫函式表達式)
  (async () => {
    const player = await initApng(img1Src, ctx);
    // const player2 = await createApngPlayer(img2Src, ctx);
    // player1.play();
    // player.pause();
    player.play();
  })();

  // const isMobile = window.innerWidth < 768;

  // const options_x = {
  //   root: null,
  //   threshold: isMobile ? 0.1 : 0.5, // 手機 0.1  桌機 0.5
  // };

  // const options = {
  //   root: null,
  //   rootMargin: "0px",
  //   threshold: 0.5,
  // };
  // 4. 修改 Observer Callback
  // const observer = new IntersectionObserver((entries) => {
  //   entries.forEach((entry) => {
  //     // 只有當元素進入畫面超過 50% 時，這裡才會變成 true
  //     if (entry.isIntersecting) {
  //       console.log("進入視線一半了，開始播放！");

  //       // 假設您用 Map 方法存 player (參考上一題)
  //       const player = playerMap.get(entry.target);
  //       if (player) {
  //         player.context.clearRect(
  //           0,
  //           0,
  //           player.context.canvas.width,
  //           player.context.canvas.height,
  //         );
  //         player.play();
  //       }
  //       observer.unobserve(entry.target); // 播了就不用再觀察了
  //     }
  //   });
  // }, options); // 把 options 傳進去
};
</script>

<template>
  <!-- <div style="min-height: 1200px"></div> -->
  <canvas id="canvas"></canvas>
  <!-- <img :src="img1Src" /> -->
</template>

<style scoped></style>
